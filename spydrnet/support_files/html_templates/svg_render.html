<!DOCTYPE html>
<meta charset="utf-8">
<title>PhyFloTa UI</title>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.0.2/d3.js"></script>
<script type="text/javascript" src="./js/spydrnet_websocket.js"></script>
<style>
  body {
    font-family: sans-serif;
  }

  .noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  #tooltip {
    background: cornsilk;
    border: 1px solid black;
    border-radius: 5px;
    padding: 5px;
  }

  svg {
    font: 10px sans-serif;
    shape-rendering: crispEdges;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #fff;
  }

  .edge:hover {
    stroke-width: 5;
    stroke: blue;
  }

  .page_comp {
    float: left;
    padding-left: 20px;
    text-align: center;
  }

  .page_comp h2 {
    margin: 10px;
  }

  #svgViewer {
    border: 2px solid grey;
  }
</style>


<body onload="init_websocket();">
  <div class="page_comp">
    <h2>PhyFloTa floorplan page</h2>
    <label for="zoom-rect"><input type="checkbox" id="zoom-rect"> zoom by rectangle</label>
  </div>
  <div id="tooltip" display="none" style="position: absolute; display: none;"></div>
  <div id="svgViewer">
    <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
      x="0px" y="0px" width="100px" height="1000px" viewBox="-150 -120 300 300" xml:space="preserve">
      <g id="mainframe">
        <text font-size="2em" fill="black" alignment-baseline="middle" text-anchor="middle" x="0" y="0">PhyFloTa</text>
      </g>
    </svg>
  </div>
</body>

<script>
  var WS_URL = "<SOCKET_URL>";
  function viewport() {
    var e = window, a = 'inner';
    if (!('innerWidth' in window)) {
      a = 'client';
      e = document.documentElement || document.body;
    }
    return { width: e[a + 'Width'], height: e[a + 'Height'] }
  }

  var margin = { top: 0, right: 12, bottom: -80, left: -20 };

  var width = viewport().width;
  var height = viewport().height;

  function showTooltip(evt, text) {
    let tooltip = document.getElementById("tooltip");
    tooltip.innerHTML = text;
    tooltip.style.display = "block";
    tooltip.style.left = evt.pageX + 10 + 'px';
    tooltip.style.top = evt.pageY + 10 + 'px';
  }

  function hideTooltip() {
    var tooltip = document.getElementById("tooltip");
    tooltip.style.display = "none";
  }


  // var x = d3.scaleLinear()
  //   .domain([-width / 2, width / 2])
  //   .range([0, width]);

  // var y = d3.scaleLinear()
  //   .domain([-height / 2, height / 2])
  //   .range([height, 0]);

  // var xAxis = d3.axisBottom(x)
  //   .tickSize(-height);

  // var yAxis = d3.axisLeft(y)
  //   .ticks(5)
  //   .tickSize(-width);


  // var zoom = d3.zoom().x(x).y(y).on("zoom", refresh);

  var d3SVG;

  function initD3() {

    d3SVG = d3.select('svg')
      .attr("width", width)
      .attr("height", height - 50)
      .attr("preserveAspectRatio", "xMidYMin")
      .call(zoom);

    // d3SVG.select("#mainframe").on("mousedown", function (event) {
    //   if (!zoomRect) return;
    //   origin = d3.pointer(event, d3SVG.node());
    //   rect = d3SVG.append("rect").attr("class", "zoom");
    //   d3.select("body").classed("noselect", true);
    //   origin[0] = Math.max(0, Math.min(width, origin[0]));
    //   origin[1] = Math.max(0, Math.min(height, origin[1]));
    //   console.log(origin);
    //   d3.select(window)
    //     .on("mousemove.zoomRect", function (event) {
    //       var m = d3.pointer(event, d3SVG.node());
    //       m[0] = Math.max(0, Math.min(width, m[0]));
    //       m[1] = Math.max(0, Math.min(height, m[1]));
    //       rect.attr("x", Math.min(origin[0], m[0]))
    //         .attr("y", Math.min(origin[1], m[1]))
    //         .attr("width", Math.abs(m[0] - origin[0]))
    //         .attr("height", Math.abs(m[1] - origin[1]));
    //     })
    //     .on("mouseup.zoomRect", function (event) {
    //       d3.select(window).on("mousemove.zoomRect", null).on("mouseup.zoomRect", null);
    //       d3.select("body").classed("noselect", false);
    //       var m = d3.pointer(event, d3SVG.node());
    //       m[0] = Math.max(0, Math.min(width, m[0]));
    //       m[1] = Math.max(0, Math.min(height, m[1]));
    //       if (m[0] !== origin[0] && m[1] !== origin[1]) {
    //         zoom.x(x.domain([origin[0], m[0]].map(x.invert).sort()))
    //           .y(y.domain([origin[1], m[1]].map(y.invert).sort()));
    //       }
    //       rect.remove();
    //       // refresh();
    //     }, true);
    //   event.stopPropagation();
    // });
  };

  d3.select(window).on("load", initD3);

  var zoomRect = false;

  d3.select("#zoom-rect").on("change", function () {
    zoomRect = this.checked;
    console.log(zoomRect);
  });

  var zoom = d3.zoom();
  zoom.on("zoom", function applyTransform(ev) {
    if (zoomRect) return;
    d3SVG.select("#mainframe").attr("transform", ev.transform);
  });

  // <ADDITIONAL JS>
</script>